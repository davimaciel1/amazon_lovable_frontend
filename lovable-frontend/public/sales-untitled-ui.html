<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard - Untitled UI Design</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inter Font (Untitled UI usa Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
    
    <script>
        // Configuração do Tailwind com cores do Untitled UI
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            25: '#FCFCFD',
                            50: '#F9FAFB',
                            100: '#F2F4F7',
                            200: '#EAECF0',
                            300: '#D0D5DD',
                            400: '#98A2B3',
                            500: '#667085',
                            600: '#475467',
                            700: '#344054',
                            800: '#1D2939',
                            900: '#101828',
                        },
                        primary: {
                            25: '#FCFAFF',
                            50: '#F9F5FF',
                            100: '#F4EBFF',
                            200: '#E9D7FE',
                            300: '#D6BBFB',
                            400: '#B692F6',
                            500: '#9E77ED',
                            600: '#7F56D9',
                            700: '#6941C6',
                            800: '#53389E',
                            900: '#42307D',
                        },
                        error: {
                            25: '#FFFBFA',
                            50: '#FEF3F2',
                            100: '#FEE4E2',
                            200: '#FECDCA',
                            300: '#FDA29B',
                            400: '#F97066',
                            500: '#F04438',
                            600: '#D92D20',
                            700: '#B42318',
                            800: '#912018',
                            900: '#7A271A',
                        },
                        warning: {
                            25: '#FFFCF5',
                            50: '#FFFAEB',
                            100: '#FEF0C7',
                            200: '#FEDF89',
                            300: '#FEC84B',
                            400: '#FDB022',
                            500: '#F79009',
                            600: '#DC6803',
                            700: '#B54708',
                            800: '#93370D',
                            900: '#7A2E0E',
                        },
                        success: {
                            25: '#F6FEF9',
                            50: '#ECFDF3',
                            100: '#D1FADF',
                            200: '#A6F4C5',
                            300: '#6CE9A6',
                            400: '#32D583',
                            500: '#12B76A',
                            600: '#039855',
                            700: '#027A48',
                            800: '#05603A',
                            900: '#054F31',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #F2F4F7;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #D0D5DD;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #98A2B3;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200">
            <!-- Logo -->
            <div class="h-16 flex items-center px-6 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center">
                        <span class="text-white font-semibold text-sm">A</span>
                    </div>
                    <span class="font-semibold text-gray-900">Amazon Monitor</span>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="p-4">
                <ul class="space-y-1">
                    <li>
                        <a href="dashboard.html" class="flex items-center gap-3 px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i data-feather="home" class="w-5 h-5"></i>
                            <span class="text-sm font-medium">Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" class="flex items-center gap-3 px-3 py-2 bg-gray-50 text-gray-900 rounded-lg">
                            <i data-feather="trending-up" class="w-5 h-5"></i>
                            <span class="text-sm font-medium">Vendas</span>
                        </a>
                    </li>
                    <li>
                        <a href="produtos.html" class="flex items-center gap-3 px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i data-feather="package" class="w-5 h-5"></i>
                            <span class="text-sm font-medium">Produtos</span>
                        </a>
                    </li>
                    <li>
                        <a href="relatorios.html" class="flex items-center gap-3 px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i data-feather="bar-chart-2" class="w-5 h-5"></i>
                            <span class="text-sm font-medium">Relatórios</span>
                        </a>
                    </li>
                    <li>
                        <a href="configuracoes.html" class="flex items-center gap-3 px-3 py-2 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            <i data-feather="settings" class="w-5 h-5"></i>
                            <span class="text-sm font-medium">Configurações</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <!-- User Profile -->
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
                <div class="flex items-center gap-3 px-3 py-2">
                    <div class="w-8 h-8 bg-gray-200 rounded-full"></div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-900">Admin User</p>
                        <p class="text-xs text-gray-500">admin@company.com</p>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto">
            <!-- Header -->
            <header class="bg-white border-b border-gray-200">
                <div class="px-8 py-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900">Vendas</h1>
                            <p class="mt-1 text-sm text-gray-500">Acompanhe suas vendas e métricas de desempenho</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                <i data-feather="download" class="w-4 h-4 inline mr-2"></i>
                                Exportar
                            </button>
                            <button onclick="loadSalesData()" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
                                <i data-feather="refresh-cw" class="w-4 h-4 inline mr-2"></i>
                                Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            </header>
            
            <div class="p-8">
                <!-- Date Filters -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-900">Período</h2>
                        <div class="flex items-center gap-2">
                            <button onclick="setQuickPeriod(7)" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">7 dias</button>
                            <button onclick="setQuickPeriod(30)" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">30 dias</button>
                            <button onclick="setQuickPeriod(90)" class="px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">90 dias</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Inicial</label>
                            <input type="date" id="startDate" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Final</label>
                            <input type="date" id="endDate" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">&nbsp;</label>
                            <button onclick="loadSalesData()" class="w-full px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded-lg hover:bg-primary-700 transition-colors">
                                Aplicar Filtro
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- KPI Cards -->
                <div class="grid grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-xl border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 bg-primary-50 rounded-lg flex items-center justify-center">
                                <i data-feather="dollar-sign" class="w-5 h-5 text-primary-600"></i>
                            </div>
                            <span class="text-xs font-medium text-success-600 bg-success-50 px-2 py-1 rounded-full">+12.5%</span>
                        </div>
                        <p class="text-sm font-medium text-gray-600 mb-1">Receita Total</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalRevenue">R$ 0,00</p>
                    </div>
                    
                    <div class="bg-white rounded-xl border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 bg-success-50 rounded-lg flex items-center justify-center">
                                <i data-feather="shopping-cart" class="w-5 h-5 text-success-600"></i>
                            </div>
                            <span class="text-xs font-medium text-success-600 bg-success-50 px-2 py-1 rounded-full">+8.2%</span>
                        </div>
                        <p class="text-sm font-medium text-gray-600 mb-1">Total de Pedidos</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalOrders">0</p>
                    </div>
                    
                    <div class="bg-white rounded-xl border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 bg-warning-50 rounded-lg flex items-center justify-center">
                                <i data-feather="package" class="w-5 h-5 text-warning-600"></i>
                            </div>
                            <span class="text-xs font-medium text-warning-600 bg-warning-50 px-2 py-1 rounded-full">+5.4%</span>
                        </div>
                        <p class="text-sm font-medium text-gray-600 mb-1">Produtos Vendidos</p>
                        <p class="text-2xl font-semibold text-gray-900" id="totalProducts">0</p>
                    </div>
                    
                    <div class="bg-white rounded-xl border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-4">
                            <div class="w-10 h-10 bg-error-50 rounded-lg flex items-center justify-center">
                                <i data-feather="trending-up" class="w-5 h-5 text-error-600"></i>
                            </div>
                            <span class="text-xs font-medium text-error-600 bg-error-50 px-2 py-1 rounded-full">-2.1%</span>
                        </div>
                        <p class="text-sm font-medium text-gray-600 mb-1">Ticket Médio</p>
                        <p class="text-2xl font-semibold text-gray-900" id="avgTicket">R$ 0,00</p>
                    </div>
                </div>
                
                <!-- Sales Chart -->
                <div class="bg-white rounded-xl border border-gray-200 p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-semibold text-gray-900">Evolução de Vendas</h2>
                        <div class="flex gap-1 p-1 bg-gray-100 rounded-lg">
                            <button onclick="setChartPeriod('daily')" id="chartPeriodDaily" class="chart-period-btn px-3 py-1.5 text-sm font-medium text-white bg-primary-600 rounded-lg transition-all">Diário</button>
                            <button onclick="setChartPeriod('weekly')" id="chartPeriodWeekly" class="chart-period-btn px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">Semanal</button>
                            <button onclick="setChartPeriod('monthly')" id="chartPeriodMonthly" class="chart-period-btn px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">Mensal</button>
                            <button onclick="setChartPeriod('yearly')" id="chartPeriodYearly" class="chart-period-btn px-3 py-1.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-all">Anual</button>
                        </div>
                    </div>
                    <div style="height: 300px;">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                
                <!-- Sales Table -->
                <div class="bg-white rounded-xl border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <h2 class="text-lg font-semibold text-gray-900">Vendas por Produto</h2>
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <i data-feather="search" class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                    <input type="text" placeholder="Buscar produto..." class="pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-600 focus:border-transparent">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left px-6 py-3">
                                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Produto</span>
                                    </th>
                                    <th class="text-left px-6 py-3">
                                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</span>
                                    </th>
                                    <th class="text-left px-6 py-3">
                                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</span>
                                    </th>
                                    <th class="text-left px-6 py-3">
                                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Pedidos</span>
                                    </th>
                                    <th class="text-left px-6 py-3">
                                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Receita</span>
                                    </th>
                                    <th class="text-left px-6 py-3">
                                        <span class="text-xs font-medium text-gray-500 uppercase tracking-wider">Status</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody" class="divide-y divide-gray-200">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loading" class="flex items-center justify-center py-12" style="display: none;">
                        <div class="text-center">
                            <div class="inline-flex items-center justify-center w-12 h-12 bg-gray-100 rounded-lg mb-4">
                                <i data-feather="loader" class="w-6 h-6 text-gray-400 animate-spin"></i>
                            </div>
                            <p class="text-sm text-gray-500">Carregando dados...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Initialize Feather Icons
        feather.replace();
        
        let salesData = [];
        let chartInstance = null;
        let currentChartPeriod = 'daily'; // Período padrão
        
        function getImageSrc(imageUrl) {
            if (!imageUrl) return 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"%3E%3Crect width="40" height="40" fill="%23F2F4F7"/%3E%3C/svg%3E';
            
            if (imageUrl.startsWith('/product-images/')) {
                return `http://localhost:8086${imageUrl}`;
            } else if (imageUrl.includes('amazon.com')) {
                return `http://localhost:8086/api/image-proxy?url=${encodeURIComponent(imageUrl)}`;
            }
            return imageUrl;
        }
        
        async function loadSalesData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            console.log('Iniciando carregamento de dados...');
            console.log('Período:', startDate, 'até', endDate);
            
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('salesTableBody').innerHTML = '';
            
            try {
                // Mudando para query simples sem CTE para evitar erro 403 (servidor só aceita SELECT)
                const query = `
                    SELECT 
                        oi.asin,
                        MAX(oi.seller_sku) as sku,
                        MAX(oi.title) as product_name,
                        MAX(p.image_url) as image_url,
                        SUM(oi.quantity_ordered) as quantity,
                        COUNT(DISTINCT oi.amazon_order_id) as order_count,
                        SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0)) as revenue
                    FROM order_items oi
                    LEFT JOIN products p ON p.asin = oi.asin
                    LEFT JOIN orders o ON o.amazon_order_id = oi.amazon_order_id
                    WHERE oi.asin IS NOT NULL
                    ${startDate ? `AND o.purchase_date >= '${startDate}'::date` : ''}
                    ${endDate ? `AND o.purchase_date <= '${endDate}'::date + interval '1 day'` : ''}
                    GROUP BY oi.asin
                    HAVING SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0)) > 0
                    ORDER BY revenue DESC
                    LIMIT 100
                `;
                
                console.log('Query SQL:', query);
                
                const response = await fetch('http://localhost:8086/api/ai-query/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sql: query })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Dados recebidos:', result);
                
                if (result.data && result.data.length > 0) {
                    salesData = result.data;
                    console.log(`${salesData.length} produtos encontrados`);
                    updateKPIs();
                    updateChart();
                    updateTable();
                } else {
                    console.log('Nenhum dado retornado');
                    document.getElementById('salesTableBody').innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-sm text-gray-500">
                                Nenhuma venda encontrada no período selecionado.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('salesTableBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-sm text-gray-500">
                            <div class="text-red-600 font-medium mb-2">Erro ao carregar dados</div>
                            <div class="text-xs">${error.message}</div>
                            <div class="text-xs mt-2">Verifique se o servidor está rodando em http://localhost:8086</div>
                        </td>
                    </tr>
                `;
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function updateKPIs() {
            const totalRevenue = salesData.reduce((sum, item) => sum + parseFloat(item.revenue || 0), 0);
            const totalOrders = salesData.reduce((sum, item) => sum + parseInt(item.order_count || 0), 0);
            const totalProducts = salesData.reduce((sum, item) => sum + parseInt(item.quantity || 0), 0);
            const avgTicket = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            
            document.getElementById('totalRevenue').textContent = `R$ ${totalRevenue.toFixed(2).replace('.', ',')}`;
            document.getElementById('totalOrders').textContent = totalOrders.toLocaleString('pt-BR');
            document.getElementById('totalProducts').textContent = totalProducts.toLocaleString('pt-BR');
            document.getElementById('avgTicket').textContent = `R$ ${avgTicket.toFixed(2).replace('.', ',')}`;
        }
        
        async function updateChart() {
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Buscar dados reais de vendas baseado no período selecionado
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            try {
                let query = '';
                let dateFormat = '';
                
                switch(currentChartPeriod) {
                    case 'daily':
                        query = `
                            SELECT 
                                DATE(o.purchase_date) as period,
                                SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0)) as revenue
                            FROM orders o
                            LEFT JOIN order_items oi ON o.amazon_order_id = oi.amazon_order_id
                            WHERE o.purchase_date IS NOT NULL
                            ${startDate ? `AND o.purchase_date >= '${startDate}'::date` : ''}
                            ${endDate ? `AND o.purchase_date <= '${endDate}'::date + interval '1 day'` : ''}
                            GROUP BY DATE(o.purchase_date)
                            ORDER BY period ASC
                        `;
                        dateFormat = { day: '2-digit', month: 'short' };
                        break;
                        
                    case 'weekly':
                        query = `
                            SELECT 
                                DATE_TRUNC('week', o.purchase_date) as period,
                                SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0)) as revenue
                            FROM orders o
                            LEFT JOIN order_items oi ON o.amazon_order_id = oi.amazon_order_id
                            WHERE o.purchase_date IS NOT NULL
                            ${startDate ? `AND o.purchase_date >= '${startDate}'::date` : ''}
                            ${endDate ? `AND o.purchase_date <= '${endDate}'::date + interval '1 day'` : ''}
                            GROUP BY DATE_TRUNC('week', o.purchase_date)
                            ORDER BY period ASC
                        `;
                        dateFormat = { day: '2-digit', month: 'short' };
                        break;
                        
                    case 'monthly':
                        query = `
                            SELECT 
                                DATE_TRUNC('month', o.purchase_date) as period,
                                SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0)) as revenue
                            FROM orders o
                            LEFT JOIN order_items oi ON o.amazon_order_id = oi.amazon_order_id
                            WHERE o.purchase_date IS NOT NULL
                            ${startDate ? `AND o.purchase_date >= '${startDate}'::date` : ''}
                            ${endDate ? `AND o.purchase_date <= '${endDate}'::date + interval '1 day'` : ''}
                            GROUP BY DATE_TRUNC('month', o.purchase_date)
                            ORDER BY period ASC
                        `;
                        dateFormat = { month: 'short', year: 'numeric' };
                        break;
                        
                    case 'yearly':
                        query = `
                            SELECT 
                                DATE_TRUNC('year', o.purchase_date) as period,
                                SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0)) as revenue
                            FROM orders o
                            LEFT JOIN order_items oi ON o.amazon_order_id = oi.amazon_order_id
                            WHERE o.purchase_date IS NOT NULL
                            ${startDate ? `AND o.purchase_date >= '${startDate}'::date` : ''}
                            ${endDate ? `AND o.purchase_date <= '${endDate}'::date + interval '1 day'` : ''}
                            GROUP BY DATE_TRUNC('year', o.purchase_date)
                            ORDER BY period ASC
                        `;
                        dateFormat = { year: 'numeric' };
                        break;
                }
                
                const response = await fetch('http://localhost:8086/api/ai-query/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ sql: query })
                });
                
                let labels = [];
                let data = [];
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.data && result.data.length > 0) {
                        // Usar dados reais com formatação apropriada
                        labels = result.data.map(item => {
                            const date = new Date(item.period);
                            return date.toLocaleDateString('pt-BR', dateFormat);
                        });
                        data = result.data.map(item => parseFloat(item.revenue || 0));
                    }
                }
                
                // Se não houver dados, criar um gráfico vazio com as datas do período
                if (labels.length === 0) {
                    const start = startDate ? new Date(startDate) : new Date();
                    const end = endDate ? new Date(endDate) : new Date();
                    start.setDate(start.getDate() - 30);
                    
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        labels.push(d.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
                        data.push(0);
                    }
                }
                
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Vendas',
                            data: data,
                            borderColor: '#7F56D9',
                            backgroundColor: 'rgba(127, 86, 217, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao carregar dados do gráfico:', error);
                // Em caso de erro, criar gráfico vazio
                const labels = [];
                const data = [];
                for (let i = 0; i < 30; i++) {
                    labels.push('');
                    data.push(0);
                }
                
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Vendas',
                            data: data,
                            borderColor: '#7F56D9',
                            backgroundColor: 'rgba(127, 86, 217, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toLocaleString('pt-BR');
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function updateTable() {
            const tbody = document.getElementById('salesTableBody');
            
            if (!salesData || salesData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-sm text-gray-500">
                            Nenhum produto encontrado
                        </td>
                    </tr>
                `;
                return;
            }
            
            const topProducts = salesData.slice(0, 20);
            console.log('Renderizando tabela com', topProducts.length, 'produtos');
            
            tbody.innerHTML = topProducts.map((item, index) => {
                const productName = item.product_name || 'Produto sem nome';
                const shortName = productName.length > 50 ? productName.substring(0, 50) + '...' : productName;
                
                return `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <img src="${getImageSrc(item.image_url)}" 
                                 alt="${productName}" 
                                 class="w-10 h-10 rounded-lg object-cover border border-gray-200"
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2240%22 height=%2240%22 viewBox=%220 0 40 40%22%3E%3Crect width=%2240%22 height=%2240%22 fill=%22%23F2F4F7%22/%3E%3C/svg%3E'">
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900" title="${productName}">${shortName}</p>
                                <p class="text-xs text-gray-500">${item.asin || 'N/A'}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-gray-900">${item.sku || '-'}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-gray-900">${parseInt(item.quantity) || 0}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-gray-900">${parseInt(item.order_count) || 0}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm font-medium text-gray-900">R$ ${parseFloat(item.revenue || 0).toFixed(2).replace('.', ',')}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            parseFloat(item.revenue) > 1000 
                                ? 'bg-success-50 text-success-700' 
                                : parseFloat(item.revenue) > 100 
                                    ? 'bg-warning-50 text-warning-700'
                                    : 'bg-gray-50 text-gray-700'
                        }">
                            ${parseFloat(item.revenue) > 1000 ? 'Top' : parseFloat(item.revenue) > 100 ? 'Médio' : 'Baixo'}
                        </span>
                    </td>
                </tr>
                `;
            }).join('');
            
            console.log('Tabela renderizada com sucesso');
        }
        
        function setQuickPeriod(days) {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
            
            loadSalesData();
        }
        
        function setChartPeriod(period) {
            // Atualizar período atual
            currentChartPeriod = period;
            
            // Atualizar estilos dos botões
            document.querySelectorAll('.chart-period-btn').forEach(btn => {
                btn.classList.remove('text-white', 'bg-primary-600');
                btn.classList.add('text-gray-700', 'bg-white', 'border', 'border-gray-300');
            });
            
            const activeBtn = document.getElementById('chartPeriod' + period.charAt(0).toUpperCase() + period.slice(1));
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-700', 'bg-white', 'border', 'border-gray-300');
                activeBtn.classList.add('text-white', 'bg-primary-600');
            }
            
            // Recarregar o gráfico com o novo período
            updateChart();
        }
        
        // Initialize dates
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        
        // Load initial data
        loadSalesData();
        
        // Refresh icons after dynamic content
        setInterval(() => feather.replace(), 1000);
    </script>
</body>
</html>