<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - Amazon Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .dashboard-layout {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .logo {
            padding: 25px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-menu {
            padding: 20px 0;
            flex: 1;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 25px;
            color: #64748b;
            text-decoration: none;
            transition: all 0.3s;
            gap: 12px;
            font-weight: 500;
            position: relative;
        }
        
        .nav-item:hover {
            background: #f8fafc;
            color: #667eea;
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(102,126,234,0.1) 0%, rgba(118,75,162,0.1) 100%);
            color: #667eea;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            background: #f8fafc;
            overflow-y: auto;
        }
        
        .header {
            background: white;
            padding: 25px 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h2 {
            margin: 0;
            color: #1e293b;
            font-size: 24px;
            font-weight: 600;
        }
        
        .header p {
            margin: 5px 0 0;
            color: #64748b;
            font-size: 14px;
        }
        
        .content {
            padding: 0 30px 30px;
        }
        
        /* Controls */
        .controls-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: 600;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            transition: all 0.3s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(102,126,234,0.2);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102,126,234,0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 4px rgba(16,185,129,0.2);
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16,185,129,0.3);
        }
        
        /* Report Cards */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .report-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .report-card:nth-child(2)::before {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .report-card:nth-child(3)::before {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .report-card:nth-child(4)::before {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .report-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .report-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .report-description {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .report-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
        }
        
        .report-frequency {
            font-size: 12px;
            color: #95a5a6;
        }
        
        .report-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status-processing {
            background: #fff3cd;
            color: #856404;
        }
        
        /* Charts Section */
        .charts-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        /* Data Table */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: linear-gradient(90deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%);
        }
        
        th {
            padding: 14px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f5;
            font-size: 14px;
            color: #2c3e50;
        }
        
        tbody tr:hover {
            background: linear-gradient(90deg, rgba(102,126,234,0.03) 0%, rgba(118,75,162,0.03) 100%);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .close-btn {
            font-size: 24px;
            color: #7f8c8d;
            cursor: pointer;
            background: none;
            border: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h1>üì¶ Amazon Monitor</h1>
            </div>
            <nav class="nav-menu">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="sales-dashboard-complete.html" class="nav-item">
                    <span>üí∞</span> Vendas
                </a>
                <a href="produtos.html" class="nav-item">
                    <span>üì¶</span> Produtos
                </a>
                <a href="relatorios.html" class="nav-item active">
                    <span>üìà</span> Relat√≥rios
                </a>
                <a href="configuracoes.html" class="nav-item">
                    <span>‚öôÔ∏è</span> Configura√ß√µes
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h2>Relat√≥rios e An√°lises</h2>
                <p>Visualize insights detalhados sobre suas vendas e produtos</p>
            </div>
            
            <div class="content">

        <!-- Controls -->
        <div class="controls-section">
            <div class="filter-group">
                <label>Per√≠odo</label>
                <select id="periodFilter">
                    <option value="7">√öltimos 7 dias</option>
                    <option value="30" selected>√öltimos 30 dias</option>
                    <option value="90">√öltimos 90 dias</option>
                    <option value="365">√öltimo ano</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Data Inicial</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label>Data Final</label>
                <input type="date" id="endDate">
            </div>
            <button class="btn btn-primary" onclick="updateReports()">Atualizar</button>
            <button class="btn btn-success" onclick="exportReport()">Exportar PDF</button>
        </div>

        <!-- Report Cards -->
        <div class="reports-grid">
            <div class="report-card" onclick="showReport('sales')">
                <div class="report-icon">üí∞</div>
                <div class="report-title">Relat√≥rio de Vendas</div>
                <div class="report-description">An√°lise completa de vendas por per√≠odo, produto e categoria</div>
                <div class="report-meta">
                    <span class="report-frequency">Atualiza√ß√£o di√°ria</span>
                    <span class="report-status status-ready">Pronto</span>
                </div>
            </div>
            
            <div class="report-card" onclick="showReport('inventory')">
                <div class="report-icon">üì¶</div>
                <div class="report-title">Relat√≥rio de Estoque</div>
                <div class="report-description">Status do invent√°rio e previs√£o de reposi√ß√£o</div>
                <div class="report-meta">
                    <span class="report-frequency">Tempo real</span>
                    <span class="report-status status-ready">Pronto</span>
                </div>
            </div>
            
            <div class="report-card" onclick="showReport('performance')">
                <div class="report-icon">üìä</div>
                <div class="report-title">Performance de Produtos</div>
                <div class="report-description">Ranking e an√°lise de desempenho por produto</div>
                <div class="report-meta">
                    <span class="report-frequency">Semanal</span>
                    <span class="report-status status-ready">Pronto</span>
                </div>
            </div>
            
            <div class="report-card" onclick="showReport('financial')">
                <div class="report-icon">üíµ</div>
                <div class="report-title">Relat√≥rio Financeiro</div>
                <div class="report-description">Receitas, custos e margens de lucro</div>
                <div class="report-meta">
                    <span class="report-frequency">Mensal</span>
                    <span class="report-status status-processing">Processando</span>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <h2 class="section-title">An√°lises Visuais</h2>
            <div class="charts-grid">
                <div>
                    <h3 class="chart-title">Vendas por Per√≠odo</h3>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="chart-title">Top 5 Produtos</h3>
                    <div class="chart-container">
                        <canvas id="productsChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="chart-title">Distribui√ß√£o por Categoria</h3>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div>
                    <h3 class="chart-title">Tend√™ncia de Crescimento</h3>
                    <div class="chart-container">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <div class="table-header">
                <h3 class="section-title">Dados Detalhados</h3>
                <button class="btn btn-primary" onclick="downloadCSV()">Baixar CSV</button>
            </div>
            <div id="loading" class="loading">Carregando dados...</div>
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Receita</th>
                        <th>Custo</th>
                        <th>Lucro</th>
                        <th>Margem</th>
                    </tr>
                </thead>
                <tbody id="dataTableBody">
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>
            </div>
        </main>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Relat√≥rio</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Report content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let salesData = [];
        let chartInstances = {};

        async function loadReportData() {
            try {
                const days = document.getElementById('periodFilter').value;
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - parseInt(days));
                
                const response = await fetch('http://localhost:8086/api/ai-query/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sql: `
                            WITH daily_sales AS (
                                SELECT 
                                    DATE(o.purchase_date) as sale_date,
                                    oi.asin,
                                    oi.title as product_name,
                                    p.category,
                                    SUM(oi.quantity_ordered) as quantity,
                                    SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0)) as revenue,
                                    SUM(COALESCE(oi.item_price, 0) * COALESCE(oi.quantity_ordered, 0) * 0.3) as cost
                                FROM order_items oi
                                LEFT JOIN orders o ON o.amazon_order_id = oi.amazon_order_id
                                LEFT JOIN products p ON p.asin = oi.asin
                                WHERE o.purchase_date >= '${startDate.toISOString().split('T')[0]}'
                                    AND oi.asin IS NOT NULL
                                GROUP BY DATE(o.purchase_date), oi.asin, oi.title, p.category
                            )
                            SELECT 
                                sale_date,
                                asin,
                                product_name,
                                category,
                                quantity,
                                revenue,
                                cost,
                                revenue - cost as profit,
                                CASE WHEN revenue > 0 THEN ((revenue - cost) / revenue) * 100 ELSE 0 END as margin
                            FROM daily_sales
                            ORDER BY sale_date DESC, revenue DESC
                        `
                    })
                });

                const result = await response.json();
                
                if (result.data) {
                    salesData = result.data;
                    updateCharts();
                    updateTable();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('dataTable').style.display = 'table';
                }
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: red;">Erro ao carregar dados. Verifique se o servidor est√° rodando.</div>';
            }
        }

        function updateCharts() {
            // Sales by Period Chart
            const salesByDate = {};
            salesData.forEach(row => {
                const date = row.sale_date ? new Date(row.sale_date).toLocaleDateString('pt-BR') : 'N/A';
                if (!salesByDate[date]) salesByDate[date] = 0;
                salesByDate[date] += parseFloat(row.revenue || 0);
            });

            const salesChartData = {
                labels: Object.keys(salesByDate).reverse().slice(-30),
                datasets: [{
                    label: 'Receita (R$)',
                    data: Object.values(salesByDate).reverse().slice(-30),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4
                }]
            };

            if (chartInstances.sales) chartInstances.sales.destroy();
            chartInstances.sales = new Chart(document.getElementById('salesChart'), {
                type: 'line',
                data: salesChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Top Products Chart
            const productSales = {};
            salesData.forEach(row => {
                const product = row.product_name || 'Sem nome';
                if (!productSales[product]) productSales[product] = 0;
                productSales[product] += parseFloat(row.revenue || 0);
            });

            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            const productsChartData = {
                labels: sortedProducts.map(p => p[0].substring(0, 30) + '...'),
                datasets: [{
                    data: sortedProducts.map(p => p[1]),
                    backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6']
                }]
            };

            if (chartInstances.products) chartInstances.products.destroy();
            chartInstances.products = new Chart(document.getElementById('productsChart'), {
                type: 'bar',
                data: productsChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Category Distribution Chart
            const categorySales = {};
            salesData.forEach(row => {
                const category = row.category || 'Sem categoria';
                if (!categorySales[category]) categorySales[category] = 0;
                categorySales[category] += parseFloat(row.revenue || 0);
            });

            const categoryChartData = {
                labels: Object.keys(categorySales),
                datasets: [{
                    data: Object.values(categorySales),
                    backgroundColor: ['#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6']
                }]
            };

            if (chartInstances.category) chartInstances.category.destroy();
            chartInstances.category = new Chart(document.getElementById('categoryChart'), {
                type: 'doughnut',
                data: categoryChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            // Growth Trend Chart
            const monthlyGrowth = {};
            salesData.forEach(row => {
                if (row.sale_date) {
                    const month = new Date(row.sale_date).toLocaleDateString('pt-BR', { year: 'numeric', month: 'short' });
                    if (!monthlyGrowth[month]) monthlyGrowth[month] = 0;
                    monthlyGrowth[month] += parseFloat(row.revenue || 0);
                }
            });

            const growthChartData = {
                labels: Object.keys(monthlyGrowth),
                datasets: [{
                    label: 'Crescimento Mensal',
                    data: Object.values(monthlyGrowth),
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4
                }]
            };

            if (chartInstances.growth) chartInstances.growth.destroy();
            chartInstances.growth = new Chart(document.getElementById('growthChart'), {
                type: 'line',
                data: growthChartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateTable() {
            const tbody = document.getElementById('dataTableBody');
            const tableData = salesData.slice(0, 50); // Show top 50 records
            
            tbody.innerHTML = tableData.map(row => `
                <tr>
                    <td>${row.sale_date ? new Date(row.sale_date).toLocaleDateString('pt-BR') : 'N/A'}</td>
                    <td>${row.product_name || 'Sem nome'}</td>
                    <td>${row.quantity || 0}</td>
                    <td>R$ ${parseFloat(row.revenue || 0).toFixed(2)}</td>
                    <td>R$ ${parseFloat(row.cost || 0).toFixed(2)}</td>
                    <td>R$ ${parseFloat(row.profit || 0).toFixed(2)}</td>
                    <td>${parseFloat(row.margin || 0).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        function updateReports() {
            loadReportData();
        }

        function exportReport() {
            alert('Exportando relat√≥rio para PDF...');
        }

        function downloadCSV() {
            const csv = [
                ['Data', 'Produto', 'Quantidade', 'Receita', 'Custo', 'Lucro', 'Margem'],
                ...salesData.map(row => [
                    row.sale_date || '',
                    row.product_name || '',
                    row.quantity || '0',
                    row.revenue || '0',
                    row.cost || '0',
                    row.profit || '0',
                    row.margin || '0'
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `relatorio_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function showReport(type) {
            const modal = document.getElementById('reportModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            const reports = {
                sales: {
                    title: 'Relat√≥rio de Vendas',
                    content: '<p>An√°lise completa das vendas...</p>'
                },
                inventory: {
                    title: 'Relat√≥rio de Estoque',
                    content: '<p>Status do invent√°rio...</p>'
                },
                performance: {
                    title: 'Performance de Produtos',
                    content: '<p>Ranking de produtos...</p>'
                },
                financial: {
                    title: 'Relat√≥rio Financeiro',
                    content: '<p>An√°lise financeira...</p>'
                }
            };

            modalTitle.textContent = reports[type].title;
            modalBody.innerHTML = reports[type].content;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('reportModal').style.display = 'none';
        }

        // Event listeners
        document.getElementById('periodFilter').addEventListener('change', function() {
            const days = parseInt(this.value);
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - days);
            
            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        });

        // Initialize
        const today = new Date();
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = today.toISOString().split('T')[0];

        loadReportData();
    </script>
</body>
</html>